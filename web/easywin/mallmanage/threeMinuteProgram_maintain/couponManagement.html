<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <title>优惠券管理</title>
    <script type="text/javascript" src="js/jquery-3.0.0.min.js"></script>
    <script type="text/javascript" src="js/image-file-visible.js"></script>
    <link rel="stylesheet" href="plugins/layui/css/layui.css" media="all"/>
    <link rel="stylesheet" href="css/global.css" media="all">
    <link rel="stylesheet" href="plugins/font-awesome/css/font-awesome.min.css">
    <link rel="stylesheet" href="css/table.css"/>
    <script type="text/javascript" src="plugins/layui/layui.js"></script>
    <script src="js/addTmpImg.js"></script>
    <script src="../../rxw/rxw.js"></script>
    <style>
        .layui-form-label {
            width: 45px;
        }

        #land {
            width: 100% !important;
        }

        .lf {
            float: left;
        }

        .rt {
            float: right;
        }

        .clear {
            clear: both;
        }

        #pic2 {
            width: 100px;
            height: 100px;
            position: absolute;
            /* top: 10px; */
            /* float: right; */
            /* right: 0; */
            opacity: 0;
            /*left: 0;*/
        }

        #image_wrap2 img {
            width: 100px !important;
            height: 100px !important;
        }

        /*.avater_titie{*/
        /*background: url('icon/touxiang.png') no-repeat;*/
        /*width:25%;*/
        /*}*/
        input {
            font-size: 15px !important;
        }

        .userCard_img,
        {
            background: url("images/add.png") no-repeat;
            background-size: 100%;
        }

        .addTwoLink {
            width: 500px;
            height: 400px;
            position: fixed;
            top: 10px;
            z-index: 999;
            background: #FFFFFF;
            left: 20%;
            border: 1px solid #e5e5e5;
            overflow-y: scroll;
        }

        .makeSure, .refuse {
            width: 60px;
            height: 30px;
            display: inline-block;
            margin-left: 15px;
            margin-top: 20px;
            margin-bottom: 20px;
            background: #009688;
            color: #FFFFFF;
            border: 0;
            border-radius: 3px;
        }

        .userCard_img_1 {
            width: 50px;
            height: 50px;
        }
        input[type='text']{
            display: inline-block;
            height: 30px;
            width:200px;
            padding: 0 10px;
            margin: 5px;
            border: 1px solid #f2f2f2;
        }
        .timeInput{
            display: inline-block;
            width:224px;
            border: 1px solid #f2f2f2;
        }
        #time, #times{
            z-index: 999;
            text-align: center;
            position: fixed;
            top: 100px;
            left: 25%;
            width: 50%;
            min-width: 300px;
            height: 300px;
            margin: 0 auto;
            background: #fff;
            border: 1px solid #f2f2f2;
        }
        .layui-input{
            height: 30px;
            width: 224px;
            margin: 5px 0;
            border: 1px solid #f2f2f2;
        }
        #screen,#refused{
            width: 50px;
            height: 30px;
            /*display: block;*/
        }
        .select{
            display: inline-block;
            width:100% ;
        }
    </style>
</head>

<body>


    <!--<blockquote class="layui-elem-quote">-->
        <div class="layui-form-pane" id="times" style="display:none">
            <div><input type="text" class="titles" placeholder="请输入标题"/></div>
            <div><input type="text" class="descs" placeholder="请输入描述"/></div>
            <div><input type="text" class="upToMoneys" placeholder="请输入满足金额"/></div>
            <div><input type="text" class="subMoneys" placeholder="请输入优惠金额"/></div>
            <!--<div class="layui-form-item" style="margin-top: 10px;margin-left: 5px">-->
                <div class="timeInput" >
                    <input class="layui-input" placeholder="开始时间(手动输入不可识别)" id="starts"
                           onclick="layui.laydate({elem: this, istime: true, format: 'YYYY-MM-DD hh:mm:ss'})">
                    <input class="layui-input" placeholder="截止时间(手动输入不可识别)" id="ends"
                           onclick="layui.laydate({elem: this, istime: true, format: 'YYYY-MM-DD hh:mm:ss'})">
                </div>
                <!--<button class="layui-btn layui-btn-small" id="screen">确认</button>-->
                <div class="select">
                    <a  href="javascript:;" style="margin-top: 3px;" class="layui-btn layui-btn-small" id="screens">确认</a>
                    <a  href="javascript:;" style="margin-top: 3px;" class="layui-btn layui-btn-small" id="refuseds">取消</a>
                </div>

            </div>
    <div class="layui-form-pane" id="time" style="display:none">
        <div><input type="text" class="title" placeholder="请输入标题"/></div>
        <div><input type="text" class="desc" placeholder="请输入描述"/></div>
        <div><input type="text" class="upToMoney" placeholder="请输入满足金额"/></div>
        <div><input type="text" class="subMoney" placeholder="请输入优惠金额"/></div>
        <!--<div class="layui-form-item" style="margin-top: 10px;margin-left: 5px">-->
        <div class="timeInput" >
            <input class="layui-input" placeholder="开始时间(手动输入不可识别)" id="start"
                   onclick="layui.laydate({elem: this, istime: true, format: 'YYYY-MM-DD hh:mm:ss'})">
            <input class="layui-input" placeholder="截止时间(手动输入不可识别)" id="end"
                   onclick="layui.laydate({elem: this, istime: true, format: 'YYYY-MM-DD hh:mm:ss'})">
        </div>
        <!--<button class="layui-btn layui-btn-small" id="screen">确认</button>-->
        <div class="select">
            <a  href="javascript:;" style="margin-top: 3px;" class="layui-btn layui-btn-small" id="screen">确认</a>
            <a  href="javascript:;" style="margin-top: 3px;" class="layui-btn layui-btn-small" id="refused">取消</a>
        </div>

    </div>
        <!--</div>-->
    <!--</blockquote>-->

<div class="admin-main">
    <blockquote class="layui-elem-quote">
        <div>
            <label class="layui-form-label" style="width:90px ">添加操作：</label>
            <a href="javascript:;" class=" layui-btn layui-btn-warm layui-btn-small" id="addOne">
                <i class="layui-icon">&#xe608;</i> 添加优惠券
            </a>

            <a href="javascript:;" style="float: right;" class="layui-btn layui-btn-small" id="refresh">
                刷新
            </a>
        </div>

    </blockquote>
    <fieldset id="land" class="layui-elem-field lf">
        <legend>一级分类</legend>
        <div class="layui-field-box">
            <table id="table1" class="lf site-table table-hover">
                <thead>
                <tr>
                    <th>ID</th>
                    <th>标题</th>
                    <th>内容</th>
                    <th>满额</th>
                    <th>优惠</th>
                    <th>开始时间</th>
                    <th>结束时间</th>
                    <th>操作</th>
                </tr>
                </thead>
                <tbody id="tbody1">
                </tbody>
            </table>
        </div>
    </fieldset>


    <div class="admin-table-page">
        <div id="page" class="page"></div>
    </div>
</div>


<script>
    rxw1.relativePath='../../'
    var token = localStorage.getItem("token");
    var mall_id = localStorage.getItem("mall_id");

    var totalPage;
    var id = '';
    layui.config({
        base: 'plugins/layui/modules/'
    });

    layui.use(['icheck', 'laypage', 'layer'], function () {
        var $ = layui.jquery,
                laypage = layui.laypage,
                layer = parent.layer === undefined ? layui.layer : parent.layer;

//        //添加优惠券
        $('#addOne').on('click', function () {
            $('#time').css('display','block');
        });
        var start = '';
        var end = '';
        $('#screen').click(function(){
            if($('#start').val() != ''){start = Date.parse($('#start').val())}else{start =''}
            if($('#end').val() != ''){end =  Date.parse($('#end').val())}else{end =  ''}
            var title=$('.title').val();
            var desc=$('.desc').val();
            var uptomoney=$('.upToMoney').val()*100;
            var submoney=$('.subMoney').val()*100;

            if($('#start').val()==''||$('#end').val()==''||title==''||desc==''||uptomoney==''||submoney==''){
                alert("请填写完整表格")
            }else{
                $.ajax({
                    type: 'POST',
                    data: {token: token,title:title,desc:desc,uptomoney:uptomoney,submoney:submoney,starttime:start,endtime:end},
                    url: '/easywin/mm/' + mall_id + '/e/couponm/addfulloff',
                    success: function (data) {
                        if (data.code == 0) {
                            $('#time').css('display','none');
                            $('.upToMoney').val('');
                            $('.subMoney').val('');
                            $('.title').val('');
                            $('.desc').val('');
                            $('#start').val('');
                            $('#end').val('');
                            $('#times').css('display', 'none');
                            $('#refresh').click();

                        } else {
                            alert(data.codeMsg);
                        }
                    }
                });
            }


        });
        $('#refused').click(function(){
            $('#time').css('display','none');
            $('.upToMoney').val('');
            $('.subMoney').val('');
            $('.title').val('');
            $('.desc').val('');
            $('#start').val('');
            $('#end').val('');
        });
        $('#refuseds').click(function(){
            $('#times').css('display','none');
            $('.upToMoney').val('');
            $('.subMoney').val('');
            $('.title').val('');
            $('.desc').val('');
            $('#start').val('');
            $('#end').val('');
        });
        var items={} ;
        function getData() {
            $.ajax({
                type: 'POST',
                data: {token: token},
                url: '/easywin/mm/' + mall_id + '/e/couponm/coupons',
                success: function (data) {
                    if (data.code == 0) {
                        $('#tbody1').children().remove();
                        var data = data.data;
                        for (var i = 0; i < data.coupons.items.length; i++) {
                            items[data.coupons.items[i].couponId]=data.coupons.items[i];
                            $('#tbody1').append('<tr class="item" itemId='+data.coupons.items[i].couponId+'>' +
                            '<td>' + data.coupons.items[i].couponId + '</td>' +
                            '<td>' + data.coupons.items[i].title + '</td>' +
                            '<td>' + data.coupons.items[i].desc + '</td>' +
                            '<td>' + data.coupons.items[i].type1Uptomoney/100 + '</td>' +
                            '<td>' + data.coupons.items[i].type1Submoney/100 + '</td>' +
                            '<td>' + new Date(parseInt(data.coupons.items[i].type1Starttime)).toLocaleString() + '</td>' +
                            '<td>' + new Date(parseInt(data.coupons.items[i].type1Endtime)).toLocaleString() + '</td>' +
                            '<td>' +
                                    '<a href="javascript:;"  style="margin-right: 10px;" class="delete layui-btn layui-btn-danger layui-btn-mini">修改</a>' +
                                    '<a href="javascript:;"  style="margin-right: 10px;" class="alterCoupon layui-btn layui-btn-danger layui-btn-mini">删除</a>' +
                            '</td>' +
                            '</tr>');
                        }
                    } else  {
                        alert(data.codeMsg);
                    }
                }
            });
        }

        getData();
//        修改信息
        var coupon_ids;
        $('#tbody1').on('click', 'a.delete', function () {
            var itemId =  $(this).parents('.item').attr('itemId');
            var item = items[itemId]
            $('#starts').val(rxw1.formatTime(item.type1Starttime) )
            $('#ends').val(rxw1.formatTime(item.type1Endtime))
             coupon_ids=$(this).parent().parent().children('td:nth-child(1)').html();
            $('#times').css('display', 'block');
            var  titles = $(this).parent().parent().children('td:nth-child(2)').html();
            var  descs = $(this).parent().parent().children('td:nth-child(3)').html();
            var  type1Uptomoneys = $(this).parent().parent().children('td:nth-child(4)').html();
            var type1Submoneys = $(this).parent().parent().children('td:nth-child(5)').html();
            $('.upToMoneys').val(type1Uptomoneys);
            $('.subMoneys').val(type1Submoneys);
            $('.titles').val(titles);
            $('.descs').val(descs);

        });

        $('#tbody1').on('click', 'a.alterCoupon',function(){
   var itemId =  $(this).parents('.item').attr('itemId');
    $.ajax({
        type: 'POST',
        data: { token: token,
            coupon_id: itemId
        },
        url: '/easywin/mm/' + mall_id + '/e/couponm/del',
        success: function (data) {
            if (data.code == 0) {
                $('#refresh').click();
            } else{
                alert(data.codeMsg);
            }
        }
    })
        })

        $('#screens').click(function(){


            if($('#starts').val() != ''){start = Date.parse($('#starts').val())}else{start =''}
            if($('#ends').val() != ''){end =  Date.parse($('#ends').val())}else{end =  ''}
            var titles =$('.titles').val();
            var descs=$('.descs').val();
            var uptomoneys=$('.upToMoneys').val()*100;
            var subMoneys=$('.subMoneys').val()*100;

            if($('#starts').val()==''||$('#ends').val()==''||titles==''||descs==''||uptomoneys==''||subMoneys==''){
                alert("请填写完整表格")
            }else {
                $.ajax({
                    type: 'POST',
                    data: {
                        token: token,
                        title: titles,
                        desc: descs,
                        uptomoney: uptomoneys,
                        submoney: subMoneys,
                        starttime: start,
                        endtime: end,
                        coupon_id: coupon_ids
                    },
                    url: '/easywin/mm/' + mall_id + '/e/couponm/alterfulloff',
                    success: function (data) {
                        if (data.code == 0) {
                            layer.msg('修改成功！', {
                                time: 2000
                            });
                            $('#times').css('display', 'none');
                            $('#refresh').click();
                        } else{
                            alert(data.codeMsg);
                        }
                    }
                })
            }
        });

//        //刷新
        $('#refresh').click(function () {
            getData();
        });


    });
</script>
<script>
    layui.use('laydate', function () {
        var $ = layui.jquery,
                laydate = layui.laydate;
    });
</script>
<script>
//    function exportData() {
//        var land = document.getElementById('land');
//        if (land.style.display == 'block') {
//            // 使用outerHTML属性获取整个table元素的HTML代码（包括<table>标签），然后包装成一个完整的HTML文档，设置charset为urf-8以防止中文乱码
//            var html = "<html><head><meta charset='utf-8' /></head><body>" + document.getElementById("table1").outerHTML + "</body></html>";
//            // 实例化一个Blob对象，其构造函数的第一个参数是包含文件内容的数组，第二个参数是包含文件类型属性的对象
//            var blob = new Blob([html], {type: "application/vnd.ms-excel"});
//            var a = document.getElementById("export");
//            // 利用URL.createObjectURL()方法为a元素生成blob URL
//            a.href = URL.createObjectURL(blob);
//            // 设置文件名，目前只有Chrome和FireFox支持此属性
//            a.download = "地推人员表.xls";
//        } else {
//            // 使用outerHTML属性获取整个table元素的HTML代码（包括<table>标签），然后包装成一个完整的HTML文档，设置charset为urf-8以防止中文乱码
//            var html = "<html><head><meta charset='utf-8' /></head><body>" + document.getElementById("table2").outerHTML + "</body></html>";
//            // 实例化一个Blob对象，其构造函数的第一个参数是包含文件内容的数组，第二个参数是包含文件类型属性的对象
//            var blob = new Blob([html], {type: "application/vnd.ms-excel"});
//            var a = document.getElementById("export");
//            // 利用URL.createObjectURL()方法为a元素生成blob URL
//            a.href = URL.createObjectURL(blob);
//            // 设置文件名，目前只有Chrome和FireFox支持此属性
//            a.download = "受邀人员表.xls";
//        }
//    }


</script>
</body>

</html>