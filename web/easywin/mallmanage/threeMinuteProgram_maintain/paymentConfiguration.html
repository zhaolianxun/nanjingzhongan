<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <title>支付配置</title>
    <link rel="stylesheet" href="plugins/layui/css/layui.css" media="all"/>
    <link rel="stylesheet" href="css/global.css" media="all">
    <link rel="stylesheet" href="plugins/font-awesome/css/font-awesome.min.css">
    <link rel="stylesheet" href="css/table.css"/>
    <link rel="stylesheet" href="css/mallDetails.css"/>
    <link rel="stylesheet" href="css/index.css"/>
    <script type="text/javascript" src="js/jquery-3.0.0.min.js"></script>
    <script type="text/javascript" src="js/image-file-visible.js"></script>
    <script type="text/javascript" src="plugins/layui/layui.js"></script>
    <script src="js/addTmpImg.js"></script>
    <style>#tbody > tr > td > img {
        max-height: 100px;
    }

    .hide {
        display: none
    }

    .serviceType {
        /*border-color: #67c23a;*/
        -webkit-appearance: none;
        background-color: #fff;
        border-radius: 4px;
        border: 1px solid #67c23a;
        box-sizing: border-box;
        color: #5a5e66;
        display: inline-block;
        font-size: inherit;
        height: 40px;
        line-height: 1;
        outline: 0;
        padding: 0 15px;
    }

    #pic2 {
        width: 280px;
        height: 50px;
        /*background:;*/
    }

    #image_wrap2 img {
        width: 200px !important;
        height: 200px !important;
    }

    /*.avater_titie{*/
    /*background: url('icon/touxiang.png') no-repeat;*/
    /*width:25%;*/
    /*}*/
    input {
        font-size: 15px !important;
    }

    </style>
</head>

<body>
<div class="admin-main">


    <fieldset class="btnFT layui-elem-field" style="border: 0">
        <div class="content-wrapper">
            <div class="mall-content content">
                <div class="mall-main el-row">
                    <div class=" btnFT el-col el-col-20">
                        <form class="el-form demo-info" onsubmit="return false">
                            <div class="el-form-item is-success is-required">

                                <div style="text-align: center;width: 100%;font-weight: 900">
                                    <span  style="color: red;font-size: 14px;line-height: 20px">请不要随意更换本页面信息，以免导致用户支付失败</span><br/>
                                    <span  style="color: red;font-size: 14px;line-height: 20px">上架前请先测试下您的商城能否支付/退款成功，已确保所填写信息正确</span>
                                </div>

                                <h5 style="margin-top: 20px;margin-bottom: 20px">一、商户号:<span class="mchcertSetted" style="color: red;font-size: 12px;line-height: 20px">请登录 <a
                                        href="https://pay.weixin.qq.com">https://pay.weixin.qq.com</a>网站，依次点击页面的 <span style="font-weight:900"> 账户中心-》商户信息-》-》基本账户信息-》微信支付商户号</span>
                                    复制填写在此处</span></h5>

                                <div class="el-form-item__content">
                                    <div class="el-input">
                                        <input autocomplete="off" type="text" rows="2" validateevent="true"
                                               class="mchid el-input__inner">
                                    </div>
                                </div>
                            </div>
                            <div class="el-form-item is-success is-required">
                                <h5 style="margin-top: 20px;margin-bottom: 20px">二、密钥:<span class="mchcertSetted" style="color: red;font-size: 12px;line-height: 20px">请登录 <a
                                        href="https://pay.weixin.qq.com">https://pay.weixin.qq.com</a>网站，依次点击页面的 <span style="font-weight:900"> 账户中心-》API安全-》设置秘钥  </span>
                                     将所填写的秘钥复制在此</span></h5>

                                <div class="el-form-item__content">
                                    <div class="layui-form-item" style="margin: 10px 0 10px;;">
                                        <input autocomplete="off" type="text" rows="2" validateevent="true"
                                               class="mchkey el-input__inner"/>
                                    </div>
                                </div>
                            </div>
                        </form>

                        <form id="mchcertpath" class="mchcertpath">
                            <h5 style="margin-top: 20px;margin-bottom: 20px">三、商户证书: <span class="mchcertSetted mchcertSette" style="color: red;font-size: 12px;line-height: 20px">请登录 <a
                                    href="https://pay.weixin.qq.com">https://pay.weixin.qq.com</a>网站，依次点击页面的 <span style="font-weight:900"> 账户中心-》API安全-》下载证书-》</span>  下载压缩文件里的.p12文件进行提交上传</span></h5>
    <span class="mchcertSet"  style="color: red;font-size: 12px;line-height: 20px"></span>
                            <div class="mingpian rt" style="height: 50px;width: 280px">
                                <input id="pic2" class="mchcert" name="mchcert" type="file" value="证书选择"/>
                            </div>
                        </form>

                        <div class="btnF el-col el-col-6">
                            <input type="button" class="btn"
                                   style="border:0;margin-top:20px;width: 80px;height: 35px;background:#009688;color: #FFFFFF;z-index: 999;border-radius: 5px;"
                                   value="确定"/>
                        </div>


                    </div>
                </div>
            </div>
        </div>

    </fieldset>

    <div class="admin-table-page">
        <div id="page" class="page"></div>
    </div>


</div>

<script src="js/metisMenu.min.js"></script>
<script src="js/custom.js"></script>
<script src="js/oss-api.js"></script>

<script>

  var token=  localStorage.getItem("token");
  var  mall_id= localStorage.getItem("mall_id");
    console.log(token)


    layui.config({
        base: 'plugins/layui/modules/'
    });

    layui.use(['icheck', 'laypage', 'layer'], function () {
        var $ = layui.jquery,
                laypage = layui.laypage,
                layer = parent.layer === undefined ? layui.layer : parent.layer;



        $().ready(function(){
            $.ajax({
                url: '/easywin/mm/'+mall_id+'/e/wxpayinfo/get?token='+token,
                type: 'POST',
                async: false,
                cache: false,
                contentType: false,
                processData: false,
                success: function (data) {
                    if (data.code == 0) {
                        $('.mchid').val(data.data.mchid);
                        $('.mchkey').val(data.data.mchkey);
                        if(data.data.mchcertSetted==1){
                            $('.mchcertSet').html('(*已上传文件)'+'<a target="_blank" href="'+data.data.mchcertUrl+'">点击查看</a>');
                        }else{
                            $('.mchcertSet').html('(*尚未上传文件)');
                        }
                    } else if (data.code == 20) {
                        layer.msg('登录已失效，请重新登录');
                    } else {
                        layer.msg(data.message);
                    }
                }
            })
        })


        $('.btn').click(function () {
            if($('#pic2').get(0).files[0].type.indexOf('pkcs12') == -1){
                alert('证书文件有误')
                return;
            }
//            var fd = new FormData(document.getElementById('pic2'));
            var formData =new FormData(document.getElementById('mchcertpath'));
            console.log(formData)

            var mchid = $('.mchid').val();
            var mchkey = $('.mchkey').val();
//            formData.append("mchcertpath",  new FormData(document.getElementById('mchcertpath')));
//            formData.append("mchid", mchid);
//            formData.append("mchkey", mchkey);
//            var mchcertpath = new FormData(document.getElementById('mchcertpath'));
//            console.log(fd);
//            var mchid=$('.mchid').val();
//            var mchkey=$('.mchkey').val();
            if (mchid == '') {
                layer.msg('请填写商户号！');
            } else if (mchkey == ' ' || mchkey == ' ') {
                layer.msg('请填写密钥！')
            } else if (formData == ' ' || formData == ' ') {
                layer.msg('请选择文件！')
            } else {
                $.ajax({
                    url: '/easywin/mm/'+mall_id+'/e/wxpayinfo/set?mchid='+mchid+'&mchkey='+mchkey+'&token='+token,
                    type: 'POST',
                    data: formData,
                    async: false,
                    cache: false,
                    contentType: false,
                    processData: false,
//                    data: {mchid:mchid,mchcertpath:formData,mchkey:mchkey,token: 301504438730},
//                    data: formData,
                    success: function (data) {
                        if (data.code == 0) {
                            alert('修改成功！');
                            history.go(-1);
                        } else if (data.code == 20) {
                            layer.msg('登录已失效，请重新登录');
                        } else {
                            layer.msg(data.message);
                        }
                    }
                })
            }

            console.log(123)
        })


    });


</script>
</body>

</html>