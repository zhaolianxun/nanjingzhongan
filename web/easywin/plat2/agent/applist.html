<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>3分钟平台</title>
    <script src="../libs/jquery.min.js"></script>
    <script src="../libs/shake.js"></script>
    <script src="../libs/jquery.cookie.js"></script>
    <script src="../libs/vue.js"></script>
    <script src="../libs/default.js"></script>

</head>
<link rel="stylesheet" type="text/css" href="../libs/iziToast/css/iziToast.min.css">
<script type="text/javascript" src="../libs/iziToast/js/iziToast.min.js"></script>
<style type="text/css">

    body{margin:0;}
    #myappContent .cardcon {
        padding: 20px 35px
    }

    #myappContent .carddiv {
        min-width: 800px;
        height: 90px;
        background: #fff;
        padding: 10px;
        margin-bottom: 20px;
        position: relative;
        box-shadow: 0 2px 4px #ccc
    }

    #myappContent .carddiv button {
        font-size: 13px;
        background: #fff;
        border: 1px solid #269abc;
        color: #269abc;
        border-radius: 3px;
        width: 70px;
        height: 25px;
        margin-top: 32px;
        margin-right: 8px
    }

    #myappContent .carddiv button:hover {
        background: #269abc;
        color: #fff
    }

    #myappContent  .cardnumimg {
        position: absolute;
        left: 0;
        top: 0;
        width: 41px
    }

    #myappContent  .cardnumtxt {
        position: absolute;
        top: 2px;
        left: 7px;
        color: #fff;
        font-weight: 700
    }

    #myappContent  .cardicon {
        width: 75px;
        float: left;
        margin-left: 30px;
        margin-top: 8px;
        border-radius: 12px
    }

    #myappContent  .carddesc {
        float: left;
        vertical-align: top;
        margin-left: 18px;
        font-size: 16px;
        width: 500px;
        overflow: hidden
    }

    #myappContent  .cardbt-con {
        float: right;
        margin-top: 2px;
        margin-right: 20px
    }

    #myappContent .vtimetxt {
        float: left;
        margin-left: 15px;
        color: #3c0;
        font-size: 13px;
        line-height: 50px;
    }
    #myappContent  .qrcodeBox{
        width: 214px;
        height: 242px;
        position: absolute;
        top: 70px;
        right: 125px;
        display: none;
        z-index: 100;
    }
    #myappContent  .qrcode{
        width: 200px;
        height: 200px;
        position: absolute;
        top: 35px;
        left: 7px;
    }
    #myappContent  #prompt{
        border-radius: 8px;
        width: 412px;
        height: 202px;
        background-color: #fff;
        margin: 0 auto;
        position: relative;
        display: none;
    }
    #myappContent  .tips{
        color: #000;
        font-size: 20px;
        line-height: 140px;
        text-align: center;
        margin: 0;
    }
    #myappContent .btnBox{
        width: 195px;
        margin: 15px auto;
    }
    #myappContent  .Btn{
        color: #fff;
        width: 80px;
        height: 30px;
        border-radius: 3px;
        text-align: center;
    }
    #myappContent  .cancelBtn{
        background-color: #ec6941;
        margin-right: 30px;
    }
    #myappContent  .alterBtn{
        background-color: #00a0e9;
    }
    #myappContent  hr{
        margin: 0;
    }

</style>
<body style="margin:0;">
<div id="myappContent">
    <!-- <div style="height:51px;border-bottom:1px solid #ddd;background:#fff">
         <span style="line-height:50px;float:left;margin-left:66px">
             <a style="display:none" href="javascript:window.parent.memuClick('userinfo');">控制台</a>
             <span style="margin:0 10px;display:none">/</span>
             <a href="myapp.html">我的应用</a>
         </span>
     </div>-->
    <div id="body-con" class="body-con">
        <div id="cardcon" class="cardcon">
            <div id="carddivFather" class="carddiv" style="display:none;">
                <img class="cardnumimg" src="../img/cardsanjiao.png">
                <div class="cardnumtxt"></div>
                <img class="cardicon" >
                <div class="carddesc">
                    <div  style="margin-top: 15px;white-space: nowrap;overflow: hidden;text-overflow: ellipsis;"><span class="cardname"></span><span class="cardmsg" style="margin-left:15px;font-size: 10px;color:red;"></span></div>
                    <div class="cardcreatetime" style="float:left;font-size: 13px;line-height:50px;"></div>
                    <div class="vtimetxt"></div>
                 <div class="belonger" style="font-size: 13px;float:left; margin-left: 15px;line-height: 50px"></div>
                </div>
                <div class="cardbt-con">
                    <button class="grantAppUseTimeBtn">增加1年</button>
                    <button class="updatebtn" style="display:none">更新</button>
                    <button class="goauthbtn" style="display:none">前往授权</button>
                    <button class="previewbtn" style="display:none" onmouseout="closeBox()">预览</button>
                    <button class="managebtn" style="display:none">管理后台</button>
                    <button class="lookstatusbtn" style="display:none">查看状态</button>
                    <div class="qrcodeBox" style="display:none">
                        <img src="../img/rectangle1@2x.png">
                        <img id="qrcode" class="qrcode" src="">
                    </div>
                </div>
                <div style="clear:both;"></div>
            </div>
        </div>
        <div style="clear:both;"></div>
    </div>
</div>
</div>

</div>
</body>

<script type="text/javascript">
    function add0(m){return m<10?'0'+m:m }
    //时间戳转化成时间格式
    function timeFormat(timestamp){
        var time = new Date(parseInt(timestamp));
        var year = time.getFullYear();
        var month = time.getMonth()+1;
        var date = time.getDate();
        return year+'-'+add0(month)+'-'+add0(date);
    }
    var token = $.cookie('token');
    var phone = '';
    var apps={};

    $.ajax({
        type: "POST",
        data: {phone:phone,page_no:1,page_size: 20},
        url:"/easywin/p/e/agent/appmanage/apps?token="+token,
        success: function (res) {
            if(res.code == 0){
                var items = res.data.apps;
                for(var i = 0 ; i < items.length ; i ++){
                    var a = items[i];
                    apps[a.appId]=a;
                    var useEndIf = null;
                    if(a.useEndtime)
                        useEndIf = false;
                    if(a.useEndtime && Date.parse( new Date()) > a.useEndtime)
                        useEndIf=true;

                    var cardcon=$('#cardcon');


                        var newCarddiv = $('#carddivFather').clone(true);
                        newCarddiv.attr('id','carddivSon'+ a.appId);
                        newCarddiv.find('.cardnumtxt').text(i+1);
                        newCarddiv.find('.cardname').text(a.nickName);
                    newCarddiv.find('.cardicon').attr('src',a.headImg);
                    newCarddiv.find('.belonger').text('所属用户: '+a.phone);
                        if(!a.businessbaseFill)
                            newCarddiv.find('.cardmsg').text('信息未补全');
                        else if(a.authorized == 0){
                            newCarddiv.find('.cardmsg').text('未授权');
                        }else if(useEndIf == true){
                            newCarddiv.find('.cardmsg').css('color','red');
                            newCarddiv.find('.cardmsg').text('使用期已过：'+ timeFormat(a.useEndtime));
                        }else if(a.auditStatus==3){
                            newCarddiv.find('.cardmsg').text('审核失败:'+ a.auditFailReason);
                        }else if(a.auditStatus==2){
                            newCarddiv.find('.cardmsg').text('审核通过');
                        }else if(a.auditStatus==1){
                            newCarddiv.find('.cardmsg').text('审核中');
                        } else if(!a.currentTemplateVersion){
                            newCarddiv.find('.cardmsg').text('未提交审核');
                        }else{
                            newCarddiv.find('.cardmsg').text('运行中');
                            newCarddiv.find('.cardmsg').css('color','green');
                        }
                        newCarddiv.find('.cardcreatetime').text('创建时间：'+ timeFormat(a.bindTime));

                        newCarddiv.find('.vtimetxt').text('有效期至：'+ timeFormat(a.useEndtime));
                        if(useEndIf == true){
                            newCarddiv.find('.vtimetxt').css('color','red');
                        }
                        newCarddiv.find('.previewbtn').css('display','');
                    newCarddiv.find('.previewbtn').attr('onclick','gotoPreview(\''+ a.appId+'\')')
                    newCarddiv.find('.grantAppUseTimeBtn').attr('onclick','grantAppUseTime(\''+ a.appId+'\','+ a.agentPrice+')')
                        newCarddiv.find('.lookstatusbtn').css('display','');
                        newCarddiv.find('.lookstatusbtn').attr('onclick','gotoStatus(\''+ a.appId+'\')')
                        newCarddiv.css('display','block');
                        newCarddiv.appendTo(cardcon);

                    }
                }
            }
    })


    //预览
    function gotoPreview(appId){
        var src ='/easywin/p/e/myapp/pretasteqrcode?token='+token+'&app_id='+appId;
        $('#carddivSon'+appId+' .qrcodeBox').css('display','block');
        $('#carddivSon'+appId+' .qrcodeBox .qrcode').attr('src',src);

    }

    //查看状态
    function gotoStatus(appId){

        location.href='agentapppreview.html?app_id='+appId;
    }

    //关闭预览
    function closeBox() {
        $('.qrcodeBox').fadeOut();
    }
    //关闭提示框
    function closePrompt(){
        $('#prompt').fadeOut();
    }




    function grantAppUseTime(appId,price){
        if(confirm('将扣除您'+price/100+'元'))
            $.ajax({
                type: 'POST',
                data: {app_id:appId},
                url: '/easywin/p/e/agent/appmanage/grantappusetime?token='+token,
                success: function(res){
                    if(res.code == 0){
                        location.reload();
                    }else{
                        alert(res.codeMsg)
                    }
                }
            })
    }

</script>

</html>