<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>表单</title>
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">

    <link rel="stylesheet" href="plugins/layui/css/layui.css" media="all" />
    <link rel="stylesheet" href="css/global.css" media="all">
    <link rel="stylesheet" href="plugins/font-awesome/css/font-awesome.min.css">
    <link rel="stylesheet" href="css/table.css" />
</head>

<body>
<div style="margin: 15px;">
    <fieldset class="layui-elem-field layui-field-title" style="margin-top: 20px;">
        <legend id="title">添加新器械</legend>
    </fieldset>

    <form class="layui-form" action="">
        <div class="layui-form-item">
            <label class="layui-form-label">注册证编号</label>
            <div class="layui-input-block">
                <input type="text" name="dataRegisterNo" autocomplete="off" placeholder="请输入注册证编号" class="layui-input">
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">注册人名称</label>
            <div class="layui-input-block">
                <input type="text" name="corporationName" autocomplete="off" placeholder="请输入注册人名称" class="layui-input">
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">注册人住所</label>
            <div class="layui-input-block">
                <input type="text" name="dataCorporationAddress" autocomplete="off" placeholder="请输入注册人住所" class="layui-input">
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">生产地址</label>
            <div class="layui-input-block">
                <input type="text" name="dataCorporationProduceAddress" autocomplete="off" placeholder="请输入生产地址" class="layui-input">
            </div>
        </div>

        <div class="layui-form-item">
            <label class="layui-form-label">代理人名称</label>
            <div class="layui-input-block">
                <input type="text" name="agencyCorporationName" autocomplete="off" placeholder="请输入代理人名称" class="layui-input">
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">代理人住所</label>
            <div class="layui-input-block">
                <input type="text" name="dataAgencyCorporationAddress" autocomplete="off" placeholder="请输入代理人住所" class="layui-input">
            </div>
        </div>

        <div class="layui-form-item">
            <label class="layui-form-label">产品名称</label>
            <div class="layui-input-block">
                <input type="text" name="dataProductName" autocomplete="off" placeholder="请输入产品名称" class="layui-input">
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">产品标准</label>
            <div class="layui-input-block">
                <input type="text" name="dataProductStandard" autocomplete="off" placeholder="请输入产品标准" class="layui-input">
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">型号、规格</label>
            <div class="layui-input-block">
                <input type="text" name="dataProductModel" autocomplete="off" placeholder="请输入产品型号、规格" class="layui-input">
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">结构及组成</label>
            <div class="layui-input-block">
                <input type="text" name="dataIngredient" autocomplete="off" placeholder="请输入产品结构及组成" class="layui-input">
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">适用范围</label>
            <div class="layui-input-block">
                <input type="text" name="dataScopeApplication" autocomplete="off" placeholder="请输入产品适用范围" class="layui-input">
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">储存条件</label>
            <div class="layui-input-block">
                <input type="text" name="dataProductCondition" autocomplete="off" placeholder="请输入产品储存条件" class="layui-input">
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">批准日期</label>
            <div class="layui-input-block">
                <input type="text" name="dataRatifyDate" placeholder="请选择批准日期" autocomplete="off" class="layui-input" onclick="layui.laydate({elem: this})">
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">有效期至</label>
            <div class="layui-input-block">
                <input type="text" name="dataExpireTime" placeholder="请选择有效日期" autocomplete="off" class="layui-input" onclick="layui.laydate({elem: this})">
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">变更日期</label>
            <div class="layui-input-block">
                <input type="text" name="changeDate" placeholder="请选择变更日期" autocomplete="off" class="layui-input" onclick="layui.laydate({elem: this})">
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">选择厂商</label>
            <div class="layui-input-block">
                <input id="name" style="width: 50%;display: inline-block;" type="text" class="layui-input" placeholder="请输入厂商名称">
                <a href="javascript:;" class="layui-btn" id="search">搜索</a>
            </div>
        </div>
        <fieldset class="layui-elem-field" style="margin-left: 110px;">
            <legend>厂商列表</legend>
            <div class="layui-field-box">
                <table class="site-table table-hover">
                    <thead>
                    <tr>
                        <th>厂商ID</th>
                        <th>厂商名称</th>
                        <th>添加时间</th>
                        <th>审核状态</th>
                        <th>操作</th>
                    </tr>
                    </thead>
                    <tbody id="tbody">
                    </tbody>
                </table>
                <div id="page" class="page"></div>
            </div>
        </fieldset>
        <p style="color: green;margin-left: 110px;">当前选择厂商为： <span id="corporationName" style="color: red;"></span></p>
        <br/>
        <div class="layui-form-item">
            <label class="layui-form-label">产品图片<br/>(最多五张)</label>
            <div class="layui-input-block">
                <input id="pic1" type="file" name="pic1" class="layui-upload-file" lay-title="请上传图片一">
                <input id="pic2" type="file" name="pic2" class="layui-upload-file" lay-title="请上传图片二">
                <input id="pic3" type="file" name="pic3" class="layui-upload-file" lay-title="请上传图片三">
                <input id="pic4" type="file" name="pic4" class="layui-upload-file" lay-title="请上传图片四">
                <input id="pic5" type="file" name="pic5" class="layui-upload-file" lay-title="请上传图片五">
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">备注</label>
            <div class="layui-input-block">
                <textarea name="dataRemark" class="layui-textarea"></textarea>
            </div>
        </div>
        <div class="layui-form-item">
            <div class="layui-input-block">
                <button class="layui-btn" lay-submit="" lay-filter="demo1">立即提交</button>
            </div>
        </div>
    </form>
</div>
<script type="text/javascript" src="plugins/layui/layui.js"></script>
<script>
    function getRequest() {
        var url = location.search; //获取url中"?"符后的字串
        var theRequest = new Object();
        if (url.indexOf("?") != -1) {
            var str = url.substr(1);
            strs = str.split("&");
            for(var i = 0; i < strs.length; i ++) {
                theRequest[strs[i].split("=")[0]]=unescape(strs[i].split("=")[1]);
            }
        }
        return theRequest;
    }
    var pic = '';
    layui.config({
        base: 'plugins/layui/modules/'
    });

    layui.use(['form','laydate', 'laypage','layer'], function() {
        var $ = layui.jquery,
            form = layui.form(),
            laypage = layui.laypage,
            layer = layui.layer;

        var id = getRequest().id;
        var name = '';
        var toPageNo = 1;
        var totalPage = 0;
        var corporationId = '';
        if(id){
            $('#title').html('修改器械信息');
            $.ajax( {
                type: 'POST',
                data: {dataId:id},
                url: '../data/detail',
                success: function(data){
                    if(data.code == 0){
                        var data = data.data;
                        corporationId = data.corporation.corporationId;
                        $('#name').val(data.corporation.corporationName);
                        $('#corporationName').html(data.corporation.corporationName);
                        for(var i = 0 ; i < data.dataDetail.length ; i ++){
                            $('[name="'+ data.dataDetail[i].column +'"]').val(data.dataDetail[i].value);
                        }
                        /*$('[name="dataRegisterNo"]').val()*/
                    }else if(data.code == 20){
                        window.parent.location.href = 'login.html';
                    }else{
                        layer.msg(data.message);
                    }
                }
            } )
        }
        function getData(){
            $.ajax( {
                type: 'GET',
                async: false,
                data: {corporationName:name,toPageNo:toPageNo},
                url: '../corporation/list',
                success: function(data){
                    if(data.code == 0){
                        $('#tbody').children().remove();
                        var data = data.data;
                        totalPage = data.sum.totalPageCount;
                        if(totalPage == 0){
                            layer.msg('无匹配数据！')
                        }else{
                            for(var i = 0;i < data.items.length ; i++){
                                var status = '';
                                if(data.items[i].corporationAdminAuthStatus =="NOTAUTH"){
                                    status = '未认证';
                                }else if(data.items[i].corporationAdminAuthStatus =="AUTHAUDITING"){
                                    status = '审核认证中';
                                }else if(data.items[i].corporationAdminAuthStatus =="AUTHREFUSE"){
                                    status = '认证拒绝';
                                }else if(data.items[i].corporationAdminAuthStatus =="AUTH"){
                                    status = '已认证';
                                }
                                $('#tbody').append('<tr>' +
                                '<td>'+ data.items[i].corporationId +'</td>' +
                                '<td><a href="children.html?id='+ data.items[i].corporationId +'">'+ data.items[i].corporationName +'</a></td>' +
                                '<td>'+ new Date(parseInt(data.items[i].corporationAddTime)).toLocaleString() +'</td>' +
                                '<td>'+ status +'</td>' +
                                '<td>' +
                                '<a href="javascript:;" class="sel layui-btn layui-btn-normal layui-btn-mini">选中</a>' +
                                '</td>' +
                                '</tr>');
                            }
                        }
                    }else if(data.code == 20){
                        alert('登录已失效，请重新登录！！');
                        window.parent.location.href = 'login.html';
                    }else{
                        layer.msg(data.message);
                    }
                }
            } );
        }
        function rePage(){
            //page
            laypage({
                cont: 'page',
                pages: totalPage,//总页数
                curr: toPageNo,
                groups: 5  ,//连续显示分页数
                jump: function(obj, first) {
                    //得到了当前页，用于向服务端请求对应数据
                    var curr = obj.curr;
                    if(!first) {
                        toPageNo = obj.curr;
                        sessionStorage.setItem('toPage',toPageNo);
                        getData();
                        layer.msg('第 '+ obj.curr +' 页');
                    }
                }
            });
        }

        $('#search').click(function(){
            name = $('#name').val();
            getData();
            rePage();
        });
        $('#tbody').on('click','a.sel',function(){
            corporationId = $(this).parent().parent().children('td:first').html();
            var corporationName = $(this).parent().parent().children('td:eq(1)').children('a').html();
            layer.msg('当前选择厂商为： '+corporationName);
            $('#corporationName').html(corporationName)
        });

        //监听提交
        form.on('submit(demo1)', function(data) {
            var a = data.field;
            var dataRemark = $('[name="dataRemark"]').val();
            pic = pic.substring(0,pic.length-1);
            if(corporationId == ''){
                layer.msg('请先选择厂商');
            }else{
                if(id){
                    $.ajax( {
                        type: 'POST',
                        data: {dataId:id,dataPic:pic,corporationId:corporationId,dataProductName: a.dataProductName,dataProductStandard: a.dataProductStandard,dataProductModel: a.dataProductModel,dataIngredient: a.dataIngredient,dataProductCondition: a.dataProductCondition,dataCorporationName: a.corporationName,dataCorporationAddress: a.dataCorporationAddress,dataCorporationProduceAddress: a.dataCorporationProduceAddress,dataAgencyCorporationAddress: a.dataAgencyCorporationAddress,dataRegisterNo: a.dataRegisterNo,dataAgencyCorporationName: a.agencyCorporationName,dataRatifyDate: a.dataRatifyDate,dataExpireTime: a.dataExpireTime,changeDate: a.changeDate,dataScopeApplication: a.dataScopeApplication,dataRemark:dataRemark},
                        url: '../m/dataalter',
                        success: function(data){
                            if(data.code == 0){
                                layer.msg('修改成功！');
                                history.go(-1);
                            }else if(data.code == 20){
                                window.parent.location.href = 'login.html';
                            }else{
                                layer.msg(data.message);
                            }
                        }
                    } )
                }else{
                    $.ajax( {
                        type: 'POST',
                        data: {dataPic:pic,corporationId:corporationId,dataProductName: a.dataProductName,dataProductStandard: a.dataProductStandard,dataProductModel: a.dataProductModel,dataIngredient: a.dataIngredient,dataProductCondition: a.dataProductCondition,dataCorporationName: a.corporationName,dataCorporationAddress: a.dataCorporationAddress,dataCorporationProduceAddress: a.dataCorporationProduceAddress,dataAgencyCorporationAddress: a.dataAgencyCorporationAddress,dataRegisterNo: a.dataRegisterNo,dataAgencyCorporationName: a.agencyCorporationName,dataRatifyDate: a.dataRatifyDate,dataExpireTime: a.dataExpireTime,changeDate: a.changeDate,dataScopeApplication: a.dataScopeApplication,dataRemark:dataRemark},
                        url: '../m/dataadd',
                        success: function(data){
                            if(data.code == 0){
                                layer.msg('添加器械成功！');
                                history.go(-1);
                            }else if(data.code == 20){
                                window.parent.location.href = 'login.html';
                            }else{
                                layer.msg(data.message);
                            }
                        }
                    } )
                }

            }
            return false;
        });
    });
    layui.use('upload', function(){
        layui.upload({
            url: 'http://passion.njshangka.com/oss/file/upload?path=yichaxun/'
            ,elem: '#pic1' //指定原始元素，默认直接查找class="layui-upload-file"
            ,method: 'post' //上传接口的http类型
            ,success: function(res){
                if(res.code == 0){
                    pic += res.data.url+',';
                    layer.msg('图片一上传成功...')
                }
            }
        });
        layui.upload({
            url: 'http://passion.njshangka.com/oss/file/upload?path=yichaxun/'
            ,elem: '#pic2' //指定原始元素，默认直接查找class="layui-upload-file"
            ,method: 'post' //上传接口的http类型
            ,success: function(res){
                if(res.code == 0){
                    pic += res.data.url+',';
                    layer.msg('图片二上传成功...')
                }
            }
        });
        layui.upload({
            url: 'http://passion.njshangka.com/oss/file/upload?path=yichaxun/'
            ,elem: '#pic3' //指定原始元素，默认直接查找class="layui-upload-file"
            ,method: 'post' //上传接口的http类型
            ,success: function(res){
                if(res.code == 0){
                    pic += res.data.url+',';
                    layer.msg('图片三上传成功...')
                }
            }
        });
        layui.upload({
            url: 'http://passion.njshangka.com/oss/file/upload?path=yichaxun/'
            ,elem: '#pic4' //指定原始元素，默认直接查找class="layui-upload-file"
            ,method: 'post' //上传接口的http类型
            ,success: function(res){
                if(res.code == 0){
                    pic += res.data.url+',';
                    layer.msg('图片四上传成功...')
                }
            }
        });
        layui.upload({
            url: 'http://passion.njshangka.com/oss/file/upload?path=yichaxun/'
            ,elem: '#pic5' //指定原始元素，默认直接查找class="layui-upload-file"
            ,method: 'post' //上传接口的http类型
            ,success: function(res){
                if(res.code == 0){
                    pic += res.data.url+',';
                    layer.msg('图片五上传成功...')
                }
            }
        });
    });
</script>
</body>

</html>